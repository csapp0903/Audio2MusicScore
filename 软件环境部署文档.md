# 软件环境部署文档

## 1.ai提问词，使用Gemini 编码助手， pro模型

我要实现一个云服务器中运行的程序，这个程序可以提供以下服务：
核心业务：客户端上传mp3格式的音频或者一个链接，服务器收到文件或者去下载链接的音频文件，经过服务器的分离降噪识别等一系列复杂处理后，识别该音频的乐谱，并且生成MusicXML格式或者Midi格式或者PDF格式的乐谱，客户端可以选择哪一种格式的文件，服务器将对应格式的文件发送到客户端。
1.安卓手机app客户端登陆账号，与服务器建立连接成功才可以使用后续服务。
2.安卓手机app中可以发送两种信息，一种是mp3格式或者其他通用音频格式的音频文件，另一种是发送视频链接供服务器下载提取音频文件。
3.对已经获取的音频文件进行处理，调用已有的流行的ai模型去进行处理。先获取到纯净的乐曲音频，再对此音频进行后处理，调用比较流行的ai模型去进行识别。
4.生成对应格式的文件可以放在服务器做，也可以让客户端app自己生成。
请你根据我的以上思路，进行评估，为我提出改进意见，以及实际需要怎么实现，只需要说出方案不需要代码。最好是生成 针对于 Cladue code的ai提示词，可以让我直接使用。

## 2.云服务器

Ubuntu 22.04 LTS

## 3.配置服务器

```bash
# 1. 更新软件源列表和软件包
sudo apt update && sudo apt upgrade -y

# 2. 安装 Python3 pip, venv (虚拟环境), git 和 build-essential (编译工具)
sudo apt install python3-pip python3-venv git build-essential libsndfile1 -y
```



```bash
# 1. 安装 Redis (消息队列数据库)
sudo apt install redis-server -y

# 2. 修改 Redis 配置让其后台运行 (Ubuntu默认通常就是，但为了保险，我们启用它)
sudo systemctl enable redis-server
sudo systemctl start redis-server

# 3. 验证 Redis 是否活着 (应该返回 PONG)
redis-cli ping

# 4. 安装 FFmpeg (音频处理瑞士军刀)
sudo apt install ffmpeg -y

# 5. 验证 FFmpeg
ffmpeg -version
```



```bash
# 1. 安装 MuseScore (通常库里是 musescore3)
sudo apt install musescore3 -y

# 2. 安装 Xvfb (虚拟显示服务)
sudo apt install xvfb -y

# 3. 测试一下 (查看版本，如果没报错说明安装成功)
xvfb-run musescore3 --version
```



```bash
# 1. 回到用户主目录
cd ~

# 2. 创建项目文件夹 (名字你随便取)
mkdir music-cloud-backend
cd music-cloud-backend

# 3. 创建 Python 虚拟环境 (命名为 venv)
python3 -m venv venv

# 4. 激活虚拟环境 (注意：每次你重新登录服务器，都要执行这一行)
source venv/bin/activate
```



```bash
# 1. 升级 pip
pip install --upgrade pip

# 2. 安装 Web 框架和 Celery
pip install fastapi "uvicorn[standard]" celery redis python-multipart requests python-jose[cryptography] passlib[bcrypt]

# 3. 安装 音频/AI 工具
# yt-dlp: 下载视频音频
# demucs: 音频分离 (Meta出品)
# basic-pitch: 音频转MIDI (Spotify出品)
pip install yt-dlp demucs basic-pitch

# 4. 安装 music21 (处理乐谱格式)
pip install music21
```



```bash
python3 -c "import torch; print(f'PyTorch Version: {torch.__version__}'); import music21; print('Music21 imported')"
```



## 4.自己电脑没办法访问服务器，因为自己8000端口号被占用

自己使用ssh建立一个中转连接

（在自己电脑上命令行里面操作）

例如：

```bash
ssh -L 8001:127.0.0.1:8000 root@x.x.x.x
```



## 5.服务器下载模型太慢，自己在自己电脑上使用一下，就下载了一个模型文件，然后用winscp传过去

```powershell
winget install "FFmpeg"
```



```bash
demucs -n htdemucs test.mp3
```



打开文件资源管理器，在地址栏输入以下路径并回车：



```Plaintext
%UserProfile%\.cache\torch\hub\checkpoints
```



（类似 `8726e21a...`）的文件

服务器目录：`/root/.cache/torch/hub/checkpoints/` (如果没有就新建)



## 6.winscp看不到.cache目录

### 通过菜单设置

如果快捷键没反应，可以手动设置：

1. 点击 WinSCP 顶部菜单栏的 **“选项” (Options)**。
2. 选择 **“首选项” (Preferences)**。
3. 在左侧菜单中点击 **“面板” (Panels)**。
4. 在右侧找到 **“显示隐藏文件” (Show hidden files)**，打上勾。
5. 点击 **“确定”**。





## 7.服务器的机器内存太小，根本放不下模型

#### 1. 创建 Swap 文件 (8GB)



```Bash
# 分配 8GB 的空间给 /swapfile
sudo fallocate -l 8G /swapfile
```

#### 2. 设置安全权限



```Bash
# 只有 root 用户可以读写，防止安全风险
sudo chmod 600 /swapfile
```

#### 3. 格式化为 Swap 格式



```Bash
# 把这个文件标记为交换空间
sudo mkswap /swapfile
```

#### 4. 启用 Swap (关键一步)



```Bash
# 激活它
sudo swapon /swapfile
```

*(如果没有报错，就说明成功了)*

#### 5. 再次验证

```Bash
free -h
```







# 怎样使用vscode远程连接云服务器

### 安装 Remote - SSH 插件

1. 打开 VS Code。
2. 点击左侧活动栏的 **扩展 (Extensions)** 图标（或者按 `Ctrl+Shift+X`）。
3. 在搜索框输入 `Remote - SSH`。
4. 找到由 **Microsoft** 发布的插件并点击 **Install**。

------

### 配置连接

#### 通过向导快速连接

1. 安装完插件后，点击 VS Code **左下角的绿色图标**（>< 形状）。
2. 在弹出的命令面板中选择 **Connect to Host... (连接到主机)**。
3. 选择 **Add New SSH Host... (添加新的 SSH 主机)**。
4. 按照格式输入 SSH 连接命令： `ssh 用户名@服务器公网IP`
   - *例如：* `ssh root@123.45.67.89`
5. 按回车，选择要保存配置的文件（通常选择第一个，如 `C:\Users\你的用户名\.ssh\config`）。
6. 右下角会提示“Host added”，点击 **Connect** 即可。

### 开启远程连接

1. 点击左侧活动栏新出现的 **远程资源管理器 (Remote Explorer)** 图标（显示为一个小显示器形状）。
2. 在 SSH 列表中，你应该能看到刚才配置的服务器（如 `my-cloud-server`）。
3. 点击服务器名称旁边的 **连接图标**（一个带箭头的文件夹图标 -> Connect to Host in New Window）。
4. **首次连接提示：**
   - VS Code 会询问服务器类型，选择 **Linux**（绝大多数云服务器是 Linux）。
   - 会询问是否信任指纹（Fingerprint），选择 **Continue**。
5. **输入密码：** 在顶部输入服务器的登录密码。

一旦连接成功，左下角的绿色图标会显示 `SSH: my-cloud-server`，且文件资源管理器将显示远程服务器的文件系统。



# 云服务器进行git上传的时候，让输入账户密码，但是一直失败

这个错误是因为 GitHub 在 2021 年停止了在命令行中使用**账户密码**进行 HTTPS 验证。现在你必须使用 **Personal Access Token (个人访问令牌)** 或者改用 **SSH 密钥**。

以下是解决这个问题的两种方法：

### 方法一：使用个人访问令牌 (PAT)

你需要生成一个“令牌”来代替密码输入。

1. **登录 GitHub 网页版**。
2. 点击右上角的头像 -> **Settings (设置)**。
3. 在左侧菜单拉到底部，点击 **Developer settings (开发者设置)**。
4. 选择 **Personal access tokens** -> **Tokens (classic)**。
5. 点击 **Generate new token** -> **Generate new token (classic)**。
6. **配置令牌：**
   - **Note (备注):** 随便填，例如 "Linux Machine"。
   - **Expiration (过期时间):** 根据需要选择（例如 90 days 或 No expiration）。
   - **Scopes (权限):** **务必勾选 `repo`** (这一项控制代码读写权限)。
7. 点击 **Generate token**。
8. **复制那串以 `ghp_` 开头的字符**。**这是你唯一能看到它的机会**。

#### 回到终端再次尝试：

再次运行 `git push`：

1. **Username:** 输入你的 GitHub 用户名 (`csapp0903`)。
2. **Password:** **粘贴你刚才复制的 Token** (不要输入你的账户密码)。
   - *注意：粘贴时屏幕上不会显示任何字符，这是正常的，粘贴后直接回车即可。*

------

### 方法二：切换到 SSH

如果你经常提交代码，配置 SSH 会更方便，不用每次都要输入密码/令牌。

由于你之前的报错显示你正在使用 HTTPS 协议 (`https://github.com/...`)，你需要修改远程仓库地址。

**如果你已经配置过 SSH 公钥：**

直接运行以下命令将仓库地址切换为 SSH 模式：

Bash

```
git remote set-url origin git@github.com:csapp0903/audio2musicscore.git
```

然后再次尝试 `git push`，如果 SSH 配置正确，就无需输入密码了。





# 有时候服务器上瞎改导致很多错误，GitHub强制拉取仓库内容，覆盖本地所有修改

```bash
# 1. 下载远程仓库的最新变动（但不合并）
git fetch --all

# 2. 将本地分支重置为远程分支的状态（这一步会丢弃已修改但未提交的文件）
git reset --hard origin/main

# 3. (可选) 如果你还想合并后续的更新（通常 reset 后不需要，但可以确保同步）
git pull
```

**注意：** 请将上面的 `main` 替换为你实际的分支名称（例如 `master`, `dev` 等）。